#!/bin/bash
# ==============================================================================
# –¢–µ—Å—Ç Rate Limiting
# ==============================================================================
# –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç 50 –∑–∞–ø—Ä–æ—Å–æ–≤ –±—ã—Å—Ç—Ä–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ —á–∞—Å—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ (429)
# ==============================================================================

URL="https://example.com/"
REQUESTS=50
SUCCESS=0
RATE_LIMITED=0

echo "=========================================="
echo "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Rate Limiting"
echo "=========================================="
echo "URL: $URL"
echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤: $REQUESTS"
echo "–û–∂–∏–¥–∞–µ–º—ã–π –ª–∏–º–∏—Ç: 10 req/s + burst 20"
echo ""
echo "–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤..."
echo ""

for i in $(seq 1 "$REQUESTS"); do
    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∏ –ø–æ–ª—É—á–∏—Ç—å HTTP –∫–æ–¥
    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -k "$URL")

    if [ "$HTTP_CODE" = "200" ]; then
        SUCCESS=$((SUCCESS + 1))
        echo -n "."
    elif [ "$HTTP_CODE" = "429" ]; then
        RATE_LIMITED=$((RATE_LIMITED + 1))
        echo -n "!"
    else
        echo -n "?"
    fi
done

echo ""
echo ""
echo "=========================================="
echo "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã"
echo "=========================================="
echo "‚úÖ –£—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (200): $SUCCESS"
echo "üõë –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (429): $RATE_LIMITED"
echo ""

if [ $RATE_LIMITED -gt 0 ]; then
    echo "‚úÖ Rate Limiting –†–ê–ë–û–¢–ê–ï–¢!"
    echo ""
    echo "–ê–Ω–∞–ª–∏–∑:"
    echo "- –õ–∏–º–∏—Ç: 10 req/s + burst 20 = ~30 –∑–∞–ø—Ä–æ—Å–æ–≤ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏"
    echo "- –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: $REQUESTS –∑–∞–ø—Ä–æ—Å–æ–≤"
    echo "- –ü—Ä–æ–ø—É—â–µ–Ω–æ: $SUCCESS –∑–∞–ø—Ä–æ—Å–æ–≤"
    echo "- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: $RATE_LIMITED –∑–∞–ø—Ä–æ—Å–æ–≤"
    echo ""
    echo "–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç DDoS."
    exit 0
else
    echo "‚ö†Ô∏è  Rate Limiting –ù–ï –°–†–ê–ë–û–¢–ê–õ"
    echo ""
    echo "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "1. –ó–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏—Å—å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±—ã—Å—Ç—Ä–æ"
    echo "2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∞—Å—å"
    echo "3. Burst —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π"
    echo ""
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
    echo "  docker logs angie | grep 'limiting requests'"
    exit 1
fi
