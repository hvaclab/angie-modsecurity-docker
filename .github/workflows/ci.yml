# ==============================================================================
# CI Pipeline for angie-modsecurity-docker
# ==============================================================================
# Triggers: push to main/develop, pull requests
# Jobs: lint, build, test, security scan
# ==============================================================================

name: CI Pipeline

on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  # Test ports (avoid conflicts with production)
  HTTP_PORT: 8080
  HTTPS_PORT: 8443

jobs:
  # --------------------------------------------------------------------------
  # Job 1: Lint configuration files
  # --------------------------------------------------------------------------
  lint:
    name: Lint Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: .
          config_file: .yamllint.yml
        continue-on-error: true

      - name: Validate Docker Compose
        run: docker compose config --quiet

      - name: Check Dockerfile with Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: angie/Dockerfile
          failure-threshold: warning

  # --------------------------------------------------------------------------
  # Job 2: Build Docker image
  # --------------------------------------------------------------------------
  build:
    name: Build Image
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Angie image
        uses: docker/build-push-action@v6
        with:
          context: ./angie
          file: ./angie/Dockerfile
          push: false
          load: true
          tags: angie-with-modsec:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Check image size
        run: |
          docker images angie-with-modsec:test --format "{{.Size}}"

      - name: Save image for tests
        run: docker save angie-with-modsec:test > /tmp/angie-image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: /tmp/angie-image.tar
          retention-days: 1

  # --------------------------------------------------------------------------
  # Job 3: Test deployment
  # --------------------------------------------------------------------------
  test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load < /tmp/angie-image.tar

      - name: Create test environment
        run: |
          # Create .env file for testing
          cat > .env << 'EOF'
          COMPOSE_PROJECT_NAME=angie-test
          TZ=UTC
          HTTP_PORT=8080
          HTTPS_PORT=8443
          EOF

          # Create required directories
          mkdir -p logs certs geoip

          # Download GeoIP database for testing
          curl -sL "https://github.com/P3TERX/GeoLite.mmdb/raw/download/GeoLite2-City.mmdb" -o geoip/GeoLite2-City.mmdb

          # Generate self-signed certificate for testing
          openssl req -x509 -nodes -days 1 \
            -newkey rsa:2048 \
            -keyout certs/default-selfsigned.key \
            -out certs/default-selfsigned.crt \
            -subj "/CN=localhost"

          # Generate DH parameters (2048 minimum for security)
          openssl dhparam -out certs/dhparam.pem 2048

      - name: Start services
        run: |
          docker compose -f compose.test.yml up -d
          sleep 15

      - name: Check container health
        run: |
          # Wait for healthy status (max 60 seconds)
          for i in {1..12}; do
            STATUS=$(docker inspect --format='{{.State.Health.Status}}' angie-test 2>/dev/null || echo "not_found")
            echo "Attempt $i: Status = $STATUS"
            if [ "$STATUS" = "healthy" ]; then
              echo "Container is healthy!"
              exit 0
            fi
            sleep 5
          done
          echo "Container did not become healthy"
          docker logs angie-test
          exit 1

      - name: Test health endpoints
        run: |
          echo "Testing /health endpoint..."
          curl -f http://localhost:18080/health || exit 1

          echo "Testing /ready endpoint..."
          curl -f http://localhost:18080/ready || exit 1

          echo "Testing /live endpoint..."
          curl -f http://localhost:18080/live || exit 1

          echo "Testing /status endpoint..."
          curl -f http://localhost:18080/status || exit 1

      - name: Test HTTPS (self-signed)
        run: |
          echo "Testing HTTPS..."
          curl -k -f https://localhost:18443/ || echo "HTTPS test (expected 444 for unknown host)"

      - name: Check logs for errors
        run: |
          echo "=== Container logs ==="
          docker logs angie-test 2>&1 | tail -50

          echo "=== Checking for critical errors ==="
          if docker logs angie-test 2>&1 | grep -i "emerg\|crit"; then
            echo "Critical errors found!"
            exit 1
          fi
          echo "No critical errors found"

      - name: Stop services
        if: always()
        run: docker compose -f compose.test.yml down -v

  # --------------------------------------------------------------------------
  # Job 4: Security scanning
  # --------------------------------------------------------------------------
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: /tmp

      - name: Load Docker image
        run: docker load < /tmp/angie-image.tar

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'angie-with-modsec:test'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ""
          extra_args: --only-verified --exclude-paths .trufflehog-exclude

  # --------------------------------------------------------------------------
  # Job 5: Validate ModSecurity rules
  # --------------------------------------------------------------------------
  modsec-validate:
    name: Validate ModSecurity
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check ModSecurity config syntax
        run: |
          # Validate modsecurity.conf structure
          if [ -f modsec/modsecurity.conf ]; then
            echo "Checking modsecurity.conf..."
            # Basic syntax validation
            grep -E "^[^#]*SecRule" modsec/modsecurity.conf | head -5 || true
            echo "ModSecurity config found and readable"
          else
            echo "Warning: modsecurity.conf not found"
          fi

      - name: List CRS rules in image
        run: |
          docker run --rm angie-with-modsec:test \
            ls -la /var/lib/angie/modsecurity/coreruleset/rules/ | head -20
