# ==============================================================================
# Fail2Ban jails для Angie
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. Блокировка некорректных HTTP запросов (HTTP 400)
# ------------------------------------------------------------------------------
[angie-bad-request]
enabled = true
filter = angie-bad-request
logpath = /var/log/angie/access.log
maxretry = 5
findtime = 300
bantime = 3600
action = iptables-allports[name=angie-bad-request]

# Параметры:
# maxretry = 5     - 5 ошибок 400
# findtime = 300   - за 5 минут
# bantime = 3600   - бан на 1 час

# ------------------------------------------------------------------------------
# 2. Блокировка атак, пойманных ModSecurity
# ------------------------------------------------------------------------------
[angie-modsecurity]
enabled = true
filter = angie-modsecurity
logpath = /var/log/angie/error.log
maxretry = 3
findtime = 300
bantime = 7200
action = iptables-allports[name=angie-modsec]

# Параметры:
# maxretry = 3     - 3 срабатывания ModSecurity
# findtime = 300   - за 5 минут
# bantime = 7200   - бан на 2 часа (атаки серьезнее)

# ------------------------------------------------------------------------------
# 3. Блокировка сканирования (поиск уязвимостей)
# ------------------------------------------------------------------------------
[angie-scan]
enabled = true
filter = angie-scan
logpath = /var/log/angie/access.log
maxretry = 10
findtime = 600
bantime = 86400
action = iptables-allports[name=angie-scan]

# Параметры:
# maxretry = 10    - 10 подозрительных 404
# findtime = 600   - за 10 минут
# bantime = 86400  - бан на 24 часа

# ------------------------------------------------------------------------------
# 4. Защита от HTTP flood / DDoS
# ------------------------------------------------------------------------------
[angie-ddos]
enabled = true
filter = angie-ddos
logpath = /var/log/angie/access.log
maxretry = 100
findtime = 60
bantime = 600
action = iptables-allports[name=angie-ddos]

# Параметры:
# maxretry = 100   - 100 запросов
# findtime = 60    - за 1 минуту (= 1.67 RPS средний)
# bantime = 600    - бан на 10 минут

# ВАЖНО: Настройте maxretry под ваш трафик!
# Если легитимные пользователи делают много запросов - увеличьте

# ------------------------------------------------------------------------------
# Глобальные настройки
# ------------------------------------------------------------------------------

# Игнорировать локальные IP
[DEFAULT]
ignoreip = 127.0.0.1/8 ::1 172.18.0.0/16

# Уведомления (опционально)
# destemail = admin@example.com
# sender = fail2ban@example.com
# action = %(action_mwl)s

# ------------------------------------------------------------------------------
# 5. Защита 3X-UI панели от брутфорса
# ------------------------------------------------------------------------------
[3x-ui-auth]
enabled = true
filter = 3x-ui-auth
logpath = /var/log/angie/access.log
maxretry = 3
findtime = 600
bantime = 3600
action = iptables-allports[name=3x-ui-auth]

# Параметры:
# maxretry = 3     - 3 неудачных попытки входа
# findtime = 600   - за 10 минут
# bantime = 3600   - бан на 1 час
