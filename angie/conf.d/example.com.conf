server {
    # HTTP/2 and HTTP/3 (QUIC) support
    listen 443 ssl;
    listen 443 quic reuseport;

    http2 on;  # Modern HTTP/2 syntax

    server_name example.com;

    # Built-in ACME for automatic Let's Encrypt certificates
    acme letsencrypt;
    ssl_certificate     $acme_cert_letsencrypt;
    ssl_certificate_key $acme_cert_key_letsencrypt;

    # Announce HTTP/3 support
    add_header Alt-Svc 'h3=":443"; ma=86400' always;

    # Security Headers (HSTS, CSP, X-Frame-Options, etc)
    include /etc/angie/includes/security/security-headers.conf;

    # Keycloak Authentication (oauth2-proxy endpoints) - Optional
    # Uncomment if you need authentication
    # include /etc/angie/includes/auth/keycloak-auth.conf;

    # Protected paths (edit keycloak-protected-paths.conf to add paths)
    # Uncomment if you need authentication
    # include /etc/angie/includes/auth/keycloak-protected-paths.conf;

    # ModSecurity
    modsecurity on;
    modsecurity_rules_file /etc/angie/modsecurity/rules.conf;

    root /var/www/html;
    index index.html;

    # File metadata caching (reduces disk I/O)
    open_file_cache max=1000 inactive=60s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # Rate Limiting for main content
    # 10 req/s + burst 20 = instant DDoS protection
    location / {
        limit_req zone=general burst=20 nodelay;
        try_files $uri $uri/ =404;

        # Browser-side HTML caching
        expires 1h;
        add_header Cache-Control "public, must-revalidate";
    }

    # Rate Limiting for static files (higher limit)
    # Browsers load many files in parallel
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|pdf|html)$ {
        limit_req zone=static burst=100 nodelay;
        expires 30d;
        add_header Cache-Control "public, immutable";

        # ETag for cache validation
        etag on;
    }

}

server {
    listen 80;
    server_name example.com;

    # ACME challenge is handled automatically by built-in @acme location

    location / {
        return 301 https://$host$request_uri;
    }
}
