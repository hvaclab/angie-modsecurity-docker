# ==============================================================================
# Default server block - handles unknown domains + health checks
# ==============================================================================

server {
    listen 80 default_server;
    listen 443 ssl default_server;

    server_name _;

    # SSL for unknown domains (self-signed fallback)
    ssl_certificate     /etc/angie/ssl/default-selfsigned.crt;
    ssl_certificate_key /etc/angie/ssl/default-selfsigned.key;
    ssl_reject_handshake on;

    # --------------------------------------------------------------------------
    # Health check endpoints (for Docker/Kubernetes/Load Balancers)
    # --------------------------------------------------------------------------

    # Health check - returns 200 OK if Angie is running
    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "healthy\n";
    }

    # Readiness check - returns 200 if ready to accept traffic
    location = /ready {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "ready\n";
    }

    # Liveness check - returns 200 if process is alive
    location = /live {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "alive\n";
    }

    # Status endpoint (JSON format)
    location = /status {
        access_log off;
        add_header Content-Type application/json;
        return 200 '{"status":"ok","service":"angie","timestamp":"$time_iso8601"}';
    }

    # --------------------------------------------------------------------------
    # Block everything else - drop connection for unknown domains
    # --------------------------------------------------------------------------
    location / {
        return 444;
    }
}
