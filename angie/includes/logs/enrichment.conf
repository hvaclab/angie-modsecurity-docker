# ==============================================================================
# УРОВЕНЬ 1: Обогащение логов на уровне Angie
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. GeoIP обогащение
# ------------------------------------------------------------------------------
geoip2 /etc/angie/geoip/GeoLite2-City.mmdb {
    auto_reload 5m;
    $geoip2_country_code country iso_code;
    $geoip2_country_name country names en;
    $geoip2_city_name city names en;
    $geoip2_continent_code continent code;
    $geoip2_latitude location latitude;
    $geoip2_longitude location longitude;
    $geoip2_timezone location time_zone;
    $geoip2_postal_code postal code;
}

# ------------------------------------------------------------------------------
# 2. User-Agent анализ
# ------------------------------------------------------------------------------

# Определяем тип устройства
map $http_user_agent $device_type {
    default "desktop";
    ~*mobile "mobile";
    ~*tablet "tablet";
    ~*bot "bot";
}

# Определяем браузер
map $http_user_agent $browser {
    default "other";
    ~*chrome "chrome";
    ~*firefox "firefox";
    ~*safari "safari";
    ~*edge "edge";
    ~*opera "opera";
}

# Определяем ОС
map $http_user_agent $os {
    default "other";
    ~*windows "windows";
    ~*mac "macos";
    ~*linux "linux";
    ~*android "android";
    ~*ios "ios";
}

# Определяем ботов
map $http_user_agent $is_bot {
    default 0;
    ~*(bot|crawler|spider|scraper|curl|wget|python|java|go-http) 1;
}

# Конкретные боты
map $http_user_agent $bot_name {
    default "";
    ~*googlebot "googlebot";
    ~*bingbot "bingbot";
    ~*yandexbot "yandexbot";
    ~*baiduspider "baiduspider";
    ~*facebookexternalhit "facebookbot";
    ~*twitterbot "twitterbot";
}

# ------------------------------------------------------------------------------
# 3. Источник трафика
# ------------------------------------------------------------------------------

# Определяем источник по реферера
map $http_referer $traffic_source {
    default "direct";
    "" "direct";
    ~*^https?://[^/]*google\. "search_google";
    ~*^https?://[^/]*yandex\. "search_yandex";
    ~*^https?://[^/]*bing\. "search_bing";
    ~*^https?://[^/]*facebook\. "social_facebook";
    ~*^https?://[^/]*twitter\. "social_twitter";
    ~*^https?://[^/]*instagram\. "social_instagram";
    ~*^https?://[^/]*linkedin\. "social_linkedin";
    ~*^https?://[^/]*vk\. "social_vk";
    ~*^https?://[^/]*t\.me "social_telegram";
}

# UTM параметры (если есть)
map $arg_utm_source $utm_source {
    default "";
}

map $arg_utm_medium $utm_medium {
    default "";
}

map $arg_utm_campaign $utm_campaign {
    default "";
}

# ------------------------------------------------------------------------------
# 4. Категоризация контента
# ------------------------------------------------------------------------------

# Тип контента по URL
map $request_uri $content_category {
    default "other";
    ~*/api/ "api";
    ~*/static/ "static";
    ~*/assets/ "static";
    ~*/images/ "media";
    ~*/videos/ "media";
    ~*/admin/ "admin";
    ~*/blog/ "blog";
    ~*/products/ "product";
    ~*/checkout/ "checkout";
}

# Тип запроса
map $request_method $request_category {
    default "read";
    GET "read";
    HEAD "read";
    POST "write";
    PUT "write";
    PATCH "write";
    DELETE "write";
}

# ------------------------------------------------------------------------------
# 5. Security анализ
# ------------------------------------------------------------------------------

# Подозрительный User-Agent
map $http_user_agent $suspicious_ua {
    default 0;
    ~*(sqlmap|nikto|nmap|masscan|metasploit|burp|acunetix|nessus|openvas|w3af|skipfish|dirbuster|gobuster|wpscan|joomla|drupal|wordpress)(?!.*legitimate) 1;
}

# Подозрительные паттерны в URL
map $request_uri $suspicious_pattern {
    default 0;
    ~*(union.*select|insert.*into|drop.*table|update.*set|\.\./|\.\.\%2f|/etc/passwd|cmd=|exec\(|eval\(|base64_decode|<script|javascript:|onerror=|onload=) 1;
}

# Подозрительные заголовки (множественные IP в X-Forwarded-For)
map $http_x_forwarded_for $suspicious_xff {
    default 0;
    ~,.*,.*,.*,.*,.*,.*,.*,.*,.*,.* 1;  # 10+ IP адресов через запятую
}

# Security Score (0-10)
# Вычисляется через простое сложение, т.к. map не поддерживает составные ключи
# Будет вычислен на уровне Vector (Level 2)

# ------------------------------------------------------------------------------
# 6. Performance метрики
# ------------------------------------------------------------------------------

# Категория скорости ответа
map $request_time $response_speed_category {
    ~^0\.0[0-1] "instant";      # <10ms
    ~^0\.0 "very_fast";          # <100ms
    ~^0\.[1-4] "fast";           # 100-499ms
    ~^0\.[5-9] "medium";         # 500-999ms
    ~^[1-2]\. "slow";            # 1-2s
    default "very_slow";         # >2s
}

# Категория размера ответа
map $bytes_sent $response_size_category {
    ~^[0-9]$ "tiny";             # <10 bytes
    ~^[0-9][0-9]$ "tiny";        # <100 bytes
    ~^[0-9][0-9][0-9]$ "tiny";   # <1KB
    ~^[0-9][0-9][0-9][0-9]$ "small";          # 1-9KB
    ~^[0-9][0-9][0-9][0-9][0-9]$ "medium";    # 10-99KB
    ~^[0-9][0-9][0-9][0-9][0-9][0-9]$ "large"; # 100KB-999KB
    default "huge";              # >1MB
}

# ------------------------------------------------------------------------------
# 7. Бизнес метрики
# ------------------------------------------------------------------------------

# Конверсионные события
map $request_uri $is_conversion {
    default 0;
    ~*/checkout/success 1;
    ~*/order/complete 1;
    ~*/payment/success 1;
    ~*/thank-you 1;
}

# A/B тест группа (из cookie)
map $cookie_ab_test $ab_group {
    default "control";
    "" "control";
}

# Уровень пользователя (из cookie)
map $cookie_user_tier $user_tier {
    default "anonymous";
    "" "anonymous";
    free "free";
    premium "premium";
    enterprise "enterprise";
}

# ------------------------------------------------------------------------------
# 8. Временные метрики
# ------------------------------------------------------------------------------

# Час дня (0-23)
map $time_iso8601 $hour_of_day {
    ~T([0-9][0-9]): $1;
}

# День недели (1-7, Monday-Sunday)
map $time_iso8601 $day_of_week {
    default 0;
}

# ------------------------------------------------------------------------------
# 9. Кэширование
# ------------------------------------------------------------------------------

# Статус кэша (если используется proxy_pass)
map $upstream_cache_status $cache_status {
    default "unknown";
    "" "bypass";
}

# ------------------------------------------------------------------------------
# 10. Обогащенный JSON формат
# ------------------------------------------------------------------------------

log_format json_enriched escape=json '{'
    # Основные данные
    '"timestamp":"$time_iso8601",'
    '"request_id":"$request_id",'

    # Клиент
    '"client_ip":"$remote_addr",'
    '"client_xff":"$http_x_forwarded_for",'
    '"client_port":"$remote_port",'

    # GeoIP
    '"geo_country_code":"$geoip2_country_code",'
    '"geo_country":"$geoip2_country_name",'
    '"geo_city":"$geoip2_city_name",'
    '"geo_continent":"$geoip2_continent_code",'
    '"geo_lat":"$geoip2_latitude",'
    '"geo_lon":"$geoip2_longitude",'
    '"geo_timezone":"$geoip2_timezone",'
    '"geo_postal":"$geoip2_postal_code",'

    # User-Agent анализ
    '"ua_string":"$http_user_agent",'
    '"ua_device":"$device_type",'
    '"ua_browser":"$browser",'
    '"ua_os":"$os",'
    '"ua_is_bot":"$is_bot",'
    '"ua_bot_name":"$bot_name",'

    # Запрос
    '"request_method":"$request_method",'
    '"request_uri":"$request_uri",'
    '"request_path":"$uri",'
    '"request_query":"$args",'
    '"request_protocol":"$server_protocol",'
    '"request_host":"$host",'
    '"request_category":"$request_category",'
    '"content_category":"$content_category",'

    # Ответ
    '"response_status":"$status",'
    '"response_bytes":"$bytes_sent",'
    '"response_body_bytes":"$body_bytes_sent",'
    '"response_size_category":"$response_size_category",'

    # Performance
    '"perf_request_time":"$request_time",'
    '"perf_speed_category":"$response_speed_category",'
    '"perf_upstream_time":"$upstream_response_time",'
    '"perf_upstream_connect_time":"$upstream_connect_time",'
    '"perf_upstream_header_time":"$upstream_header_time",'
    '"perf_cache_status":"$cache_status",'

    # SSL/TLS
    '"ssl_protocol":"$ssl_protocol",'
    '"ssl_cipher":"$ssl_cipher",'
    '"ssl_session_reused":"$ssl_session_reused",'

    # Источник трафика
    '"traffic_source":"$traffic_source",'
    '"traffic_referer":"$http_referer",'
    '"traffic_utm_source":"$utm_source",'
    '"traffic_utm_medium":"$utm_medium",'
    '"traffic_utm_campaign":"$utm_campaign",'

    # Security
    '"security_suspicious_ua":"$suspicious_ua",'
    '"security_suspicious_pattern":"$suspicious_pattern",'
    '"security_suspicious_xff":"$suspicious_xff",'

    # Бизнес метрики
    '"business_is_conversion":"$is_conversion",'
    '"business_ab_group":"$ab_group",'
    '"business_user_tier":"$user_tier",'

    # Сервер
    '"server_name":"$server_name",'
    '"server_hostname":"$hostname",'
    '"server_pid":"$pid",'
    '"server_connection":"$connection",'
    '"server_connection_requests":"$connection_requests"'
'}';
