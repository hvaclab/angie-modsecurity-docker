# ==============================================================================
# Keycloak Authentication Configuration
# ==============================================================================
# Интеграция с Keycloak через oauth2-proxy и auth_request
#
# Файл: /etc/angie/keycloak-auth.conf
# Использование: include /etc/angie/keycloak-auth.conf; (в server блоке)
# ==============================================================================

# ------------------------------------------------------------------------------
# Internal auth endpoint (oauth2-proxy)
# ------------------------------------------------------------------------------
# Этот location обрабатывает проверку авторизации
# oauth2-proxy должен быть запущен на порту 4180

location = /oauth2/auth {
    internal;
    proxy_pass http://oauth2-proxy:4180/oauth2/auth;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Uri $request_uri;

    # Cache auth responses for performance
    proxy_cache_valid 202 1m;
}

# ------------------------------------------------------------------------------
# OAuth2 callback and sign-in/out endpoints
# ------------------------------------------------------------------------------
location /oauth2/ {
    proxy_pass http://oauth2-proxy:4180;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Auth-Request-Redirect $request_uri;

    # Увеличенные буферы для больших JWT токенов (много ролей/групп)
    proxy_buffer_size 32k;
    proxy_buffers 8 32k;
    proxy_busy_buffers_size 64k;
}

# ------------------------------------------------------------------------------
# Error page for unauthorized access
# ------------------------------------------------------------------------------
# Редирект на страницу входа при 401 ошибке
location @oauth2_signin {
    internal;
    # Сохраняем оригинальный URL для редиректа после входа
    add_header Set-Cookie "_oauth2_proxy_redirect=$scheme://$host$request_uri; Path=/; HttpOnly; Secure; SameSite=Lax";
    return 302 /oauth2/start?rd=$scheme://$host$request_uri;
}

# ==============================================================================
# Инструкции по использованию
# ==============================================================================
#
# 1. Подключить этот файл в server блоке:
#    include /etc/angie/keycloak-auth.conf;
#
# 2. Подключить защищаемые пути:
#    include /etc/angie/keycloak-protected-paths.conf;
#
# 3. Для защиты конкретного location добавить:
#    location /admin {
#        auth_request /oauth2/auth;
#        error_page 401 = @oauth2_signin;
#
#        # Передать информацию о пользователе в upstream
#        auth_request_set $user $upstream_http_x_auth_request_user;
#        auth_request_set $email $upstream_http_x_auth_request_email;
#        auth_request_set $groups $upstream_http_x_auth_request_groups;
#        proxy_set_header X-User $user;
#        proxy_set_header X-Email $email;
#        proxy_set_header X-Groups $groups;
#
#        # ... остальная конфигурация location
#    }
#
# ==============================================================================
