# ==============================================================================
# Advanced Compression Configuration (Brotli + Zstd + Gzip)
# ==============================================================================
# Файл: /etc/angie/includes/performance/compression.conf
# Требует: brotli, zstd модули
# ==============================================================================

# ------------------------------------------------------------------------------
# Brotli Compression (Google)
# ------------------------------------------------------------------------------
# Более эффективное сжатие чем gzip (15-20% меньше размер)
# Поддержка: Chrome, Firefox, Edge, Safari 14+

brotli on;
brotli_comp_level 6;  # 0-11, баланс скорость/сжатие
brotli_min_length 256;  # Минимальный размер для сжатия
brotli_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/x-javascript
    application/json
    application/xml
    application/xml+rss
    application/rss+xml
    application/atom+xml
    application/xhtml+xml
    image/svg+xml
    font/truetype
    font/opentype
    font/woff
    font/woff2;

# Использовать предсжатые .br файлы если есть
brotli_static on;

# ------------------------------------------------------------------------------
# Zstd Compression (Facebook)
# ------------------------------------------------------------------------------
# Быстрая декомпрессия, отличное сжатие
# Поддержка: Chrome 123+, Firefox 126+

zstd on;
zstd_comp_level 6;  # 1-22, рекомендуется 3-9
zstd_min_length 256;
zstd_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/x-javascript
    application/json
    application/xml
    application/xml+rss;

# Использовать предсжатые .zst файлы если есть
zstd_static on;

# ------------------------------------------------------------------------------
# Gzip Compression (Fallback)
# ------------------------------------------------------------------------------
# Универсальная поддержка всех браузеров

gzip on;
gzip_comp_level 6;  # 1-9
gzip_min_length 256;
gzip_types
    text/plain
    text/css
    text/xml
    text/javascript
    application/javascript
    application/x-javascript
    application/json
    application/xml
    application/xml+rss
    application/rss+xml
    application/atom+xml
    image/svg+xml;

# Сжатие для проксированных запросов
gzip_proxied any;

# Добавить Vary: Accept-Encoding для кэшей
gzip_vary on;

# Отключить gzip для старых IE
gzip_disable "msie6";

# ==============================================================================
# Порядок приоритета:
# 1. Brotli (если браузер поддерживает)
# 2. Zstd (если браузер поддерживает)
# 3. Gzip (fallback для всех)
# ==============================================================================

# ==============================================================================
# Создание предсжатых файлов
# ==============================================================================
# Для максимальной производительности создавайте предсжатые версии:
#
# # Brotli
# find /var/www/html -type f \( -name "*.css" -o -name "*.js" -o -name "*.html" \) \
#   -exec sh -c 'brotli -f -k -q 11 "$1"' _ {} \;
#
# # Zstd
# find /var/www/html -type f \( -name "*.css" -o -name "*.js" -o -name "*.html" \) \
#   -exec sh -c 'zstd -f -k -19 "$1"' _ {} \;
#
# # Gzip
# find /var/www/html -type f \( -name "*.css" -o -name "*.js" -o -name "*.html" \) \
#   -exec sh -c 'gzip -f -k -9 "$1"' _ {} \;
# ==============================================================================

# ==============================================================================
# Примечания:
# - Все три метода могут работать одновременно
# - Angie автоматически выберет лучший метод для каждого клиента
# - Предсжатые файлы (.br, .zst, .gz) обслуживаются без CPU нагрузки
# - Экономия трафика: 25-35% по сравнению с несжатым контентом
# ==============================================================================
