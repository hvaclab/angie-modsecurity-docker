# ==============================================================================
# Advanced Headers Configuration (Headers More)
# ==============================================================================
# Файл: /etc/angie/includes/security/headers-advanced.conf
# Требует: ngx_http_headers_more_filter_module
# ==============================================================================

# ------------------------------------------------------------------------------
# Полное скрытие Server fingerprint
# ------------------------------------------------------------------------------
# Удаляет заголовок Server полностью (лучше чем server_tokens off)
more_clear_headers 'Server';

# ------------------------------------------------------------------------------
# Удаление заголовков от backend
# ------------------------------------------------------------------------------
# Убираем информацию о backend технологиях
more_clear_headers 'X-Powered-By';
more_clear_headers 'X-AspNet-Version';
more_clear_headers 'X-AspNetMvc-Version';
more_clear_headers 'X-Runtime';
more_clear_headers 'X-Version';

# ------------------------------------------------------------------------------
# Безопасные заголовки только для успешных ответов
# ------------------------------------------------------------------------------
# Добавляем security headers только для 2xx и 3xx кодов
# Это предотвращает утечку информации на error pages

# HSTS только для успешных запросов
more_set_headers -s '200 201 204 206 301 302 303 304 307 308' \
    'Strict-Transport-Security: max-age=31536000; includeSubDomains; preload';

# X-Content-Type-Options
more_set_headers -s '200 201 204 206' \
    'X-Content-Type-Options: nosniff';

# X-Frame-Options
more_set_headers -s '200 201 204 206' \
    'X-Frame-Options: SAMEORIGIN';

# ------------------------------------------------------------------------------
# Условные заголовки
# ------------------------------------------------------------------------------
# Можно добавлять заголовки в зависимости от условий
# Примеры закомментированы:

# Добавить CORS только для API endpoints
# location /api/ {
#     more_set_headers 'Access-Control-Allow-Origin: *';
#     more_set_headers 'Access-Control-Allow-Methods: GET, POST, OPTIONS';
# }

# Различные Cache-Control для разных типов контента
# location ~* \.(jpg|jpeg|png|gif|ico)$ {
#     more_set_headers 'Cache-Control: public, max-age=2592000, immutable';
# }
#
# location ~* \.(css|js)$ {
#     more_set_headers 'Cache-Control: public, max-age=604800, must-revalidate';
# }

# ------------------------------------------------------------------------------
# Debug заголовки (только для development)
# ------------------------------------------------------------------------------
# Раскомментируйте для дебага:
# more_set_headers 'X-Request-ID: $request_id';
# more_set_headers 'X-Response-Time: $request_time';
# more_set_headers 'X-Upstream-Addr: $upstream_addr';
# more_set_headers 'X-Upstream-Response-Time: $upstream_response_time';

# ------------------------------------------------------------------------------
# Удаление заголовков из upstream ответов
# ------------------------------------------------------------------------------
# Очищаем чувствительные заголовки от проксированных серверов
# more_clear_headers -s '401 403 404 500 502 503' 'WWW-Authenticate';

# ==============================================================================
# Преимущества Headers More над стандартным add_header:
# ==============================================================================
# 1. more_clear_headers - полностью удаляет заголовок
# 2. Работает на любом этапе обработки (not just success responses)
# 3. Фильтрация по HTTP status codes (-s flag)
# 4. Можно изменять заголовки от upstream серверов
# 5. Условная обработка заголовков
# ==============================================================================

# ==============================================================================
# Примечания:
# - more_set_headers заменяет существующий заголовок
# - more_add_headers добавляет, не заменяя
# - Используйте -s для указания status codes
# - Применяется ДО add_header директив
# ==============================================================================
