# ==============================================================================
# Security Headers Configuration
# ==============================================================================
# Защита от XSS, clickjacking, MIME sniffing и других атак на уровне браузера
#
# Файл: /etc/angie/security-headers.conf
# Использование: include /etc/angie/security-headers.conf;
# ==============================================================================

# ------------------------------------------------------------------------------
# 1. HTTP Strict Transport Security (HSTS)
# ------------------------------------------------------------------------------
# Принуждает браузер всегда использовать HTTPS
# max-age=2592000 - 30 дней - БЕЗОПАСНО для Let's Encrypt (certbot обновляет за 30 дней)
# max-age=7776000 - 90 дней - можно после проверки стабильности certbot
# max-age=31536000 - 1 год - только для коммерческих сертификатов
# includeSubDomains - применить ко всем поддоменам
# preload - включение в HSTS Preload List браузеров (опционально)

add_header Strict-Transport-Security "max-age=2592000; includeSubDomains" always;

# ВАЖНО: Раскомментировать "preload" только после проверки на https://hstspreload.org/
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# ------------------------------------------------------------------------------
# 2. X-Content-Type-Options
# ------------------------------------------------------------------------------
# Запрещает браузеру угадывать MIME-тип (защита от MIME sniffing)
# Браузер будет строго следовать Content-Type заголовку

add_header X-Content-Type-Options "nosniff" always;

# ------------------------------------------------------------------------------
# 3. X-Frame-Options
# ------------------------------------------------------------------------------
# Защита от clickjacking атак
# DENY - запретить загрузку сайта в iframe полностью
# SAMEORIGIN - разрешить только с того же домена

add_header X-Frame-Options "SAMEORIGIN" always;

# Если нужно разрешить iframe с вашего домена:
# add_header X-Frame-Options "SAMEORIGIN" always;

# ------------------------------------------------------------------------------
# 4. X-XSS-Protection
# ------------------------------------------------------------------------------
# Устаревший заголовок, но все еще поддерживается старыми браузерами
# Современные браузеры используют CSP вместо этого

add_header X-XSS-Protection "1; mode=block" always;

# ------------------------------------------------------------------------------
# 5. Referrer-Policy
# ------------------------------------------------------------------------------
# Контролирует какую информацию о referrer отправляет браузер
# no-referrer-when-downgrade - не отправлять referrer при переходе с HTTPS на HTTP

add_header Referrer-Policy "no-referrer-when-downgrade" always;

# Более строгие варианты:
# add_header Referrer-Policy "no-referrer" always;  # Никогда не отправлять
# add_header Referrer-Policy "same-origin" always;  # Только для того же домена

# ------------------------------------------------------------------------------
# 6. Permissions-Policy (ранее Feature-Policy)
# ------------------------------------------------------------------------------
# Контролирует доступ к API браузера (камера, микрофон, геолокация и т.д.)
# Блокируем все опасные API

add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=(), fullscreen=(self)" always;

# Если нужно разрешить некоторые API:
# geolocation=(self) - разрешить геолокацию только для своего домена
# camera=(self "https://trusted.com") - разрешить камеру для своего домена и trusted.com

# ------------------------------------------------------------------------------
# 7. Content-Security-Policy (CSP)
# ------------------------------------------------------------------------------
# КРИТИЧЕСКИ ВАЖНО: CSP может сломать функциональность сайта!
# Тестируйте в режиме report-only перед применением!

# Режим report-only (только логирование, не блокирует):
# add_header Content-Security-Policy-Report-Only "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" always;

# Строгий CSP (блокирует все кроме разрешенного):
# ВНИМАНИЕ: Убраны 'unsafe-inline' и 'unsafe-eval' для максимальной безопасности
# Если сайт перестал работать - добавьте их обратно
add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self'; base-uri 'self'; form-action 'self';" always;

# Объяснение директив:
# default-src 'self' - по умолчанию разрешены только ресурсы с того же домена
# script-src 'self' 'unsafe-inline' - скрипты: свой домен + inline (небезопасно, но часто нужно)
# style-src 'self' 'unsafe-inline' - стили: свой домен + inline
# img-src 'self' data: https: - картинки: свой домен + data: URI + любой HTTPS
# font-src 'self' data: - шрифты: свой домен + data: URI
# connect-src 'self' - AJAX/WebSocket только на свой домен
# frame-ancestors 'none' - запретить загрузку в iframe (дублирует X-Frame-Options)
# base-uri 'self' - ограничить <base> тег
# form-action 'self' - формы могут отправляться только на свой домен

# ВАЖНО: Если у вас есть внешние ресурсы (Google Analytics, CDN и т.д.), добавьте их:
# script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://cdn.example.com;
# img-src 'self' data: https: https://www.google-analytics.com;

# ------------------------------------------------------------------------------
# 8. Дополнительные заголовки
# ------------------------------------------------------------------------------

# Отключаем информацию о сервере (уже есть server_tokens off в angie.conf)
# more_clear_headers 'Server';  # Требует модуль headers-more

# Cross-Origin заголовки (для A+ рейтинга и изоляции)
add_header Cross-Origin-Embedder-Policy "require-corp" always;
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Resource-Policy "same-origin" always;

# ------------------------------------------------------------------------------
# Тестирование
# ------------------------------------------------------------------------------
#
# После применения проверьте:
# 1. https://securityheaders.com/ - должны получить A+ рейтинг
# 2. Проверьте работоспособность сайта (особенно внешние скрипты/стили)
# 3. Проверьте консоль браузера на CSP ошибки
#
# Для отладки CSP используйте режим report-only (см. выше)
#
# ==============================================================================
