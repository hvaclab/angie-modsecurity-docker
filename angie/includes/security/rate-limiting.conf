# ==============================================================================
# Rate Limiting Configuration
# ==============================================================================
# Защита от DDoS и абузов на уровне Angie (до попадания в ModSecurity)
#
# Преимущества:
# - Мгновенная реакция (не нужно ждать накопления в логах как в fail2ban)
# - Минимальная нагрузка (~0.01% CPU)
# - Защита всех endpoints
#
# Файл: /etc/angie/rate-limiting.conf
# ==============================================================================

# ------------------------------------------------------------------------------
# Определение зон rate limiting
# ------------------------------------------------------------------------------

# Зона для общего трафика
# $binary_remote_addr - IP адрес клиента (бинарный формат, экономия памяти)
# zone=general:10m - имя зоны "general", размер 10MB (~160,000 IP адресов)
# rate=10r/s - максимум 10 запросов в секунду на один IP
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

# Зона для статических файлов (картинки, CSS, JS)
# rate=50r/s - более высокий лимит, т.к. браузер загружает много файлов параллельно
limit_req_zone $binary_remote_addr zone=static:10m rate=50r/s;

# Зона для API endpoints (если будут)
# rate=5r/s - более строгий лимит для API
limit_req_zone $binary_remote_addr zone=api:10m rate=5r/s;

# Зона для форм и POST запросов
# rate=2r/s - строгий лимит для форм (защита от спама)
limit_req_zone $binary_remote_addr zone=forms:10m rate=2r/s;

# ------------------------------------------------------------------------------
# Настройка поведения при превышении лимита
# ------------------------------------------------------------------------------

# Код ответа при превышении лимита (429 Too Many Requests)
limit_req_status 429;

# Логирование rate limiting событий
# warn - записывать в error.log когда клиент превышает лимит
limit_req_log_level warn;

# ------------------------------------------------------------------------------
# Примечания по параметрам применения
# ------------------------------------------------------------------------------

# При применении в location используйте:
#
# limit_req zone=general burst=20 nodelay;
#
# Где:
# - zone=general - какую зону использовать
# - burst=20 - разрешить всплеск до 20 запросов
# - nodelay - обрабатывать всплеск сразу (не задерживать)
#
# Пример burst:
# Лимит 10r/s, burst=20
# - Нормальный трафик: 10 запросов в секунду - ОК
# - Всплеск: 30 запросов за 1 секунду:
#   - Первые 30 запросов обработаны (10 + 20 burst) - ОК
#   - Следующие запросы - отклонены (429)
#
# nodelay vs delay:
# - nodelay - обработать burst сразу (рекомендуется)
# - delay - обработать burst постепенно (очередь)

# ------------------------------------------------------------------------------
# Whitelist (опционально)
# ------------------------------------------------------------------------------

# Создать map для whitelist IP адресов
# geo $limit {
#     default 1;
#     127.0.0.1 0;           # localhost
#     172.18.0.0/16 0;       # Docker network
#     10.0.0.0/8 0;          # Внутренняя сеть
#     # Добавьте доверенные IP:
#     # 1.2.3.4 0;           # Ваш IP
# }
#
# map $limit $limit_key {
#     0 "";
#     1 $binary_remote_addr;
# }
#
# Затем использовать $limit_key вместо $binary_remote_addr:
# limit_req_zone $limit_key zone=general:10m rate=10r/s;

# ==============================================================================
