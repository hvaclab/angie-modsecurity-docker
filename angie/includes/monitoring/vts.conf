# ==============================================================================
# Virtual Host Traffic Status (VTS) - Реал-тайм метрики
# ==============================================================================
# Файл: /etc/angie/includes/monitoring/vts.conf
# Требует: ngx_http_vhost_traffic_status_module
# ==============================================================================

# ------------------------------------------------------------------------------
# Глобальная зона для сбора метрик
# ------------------------------------------------------------------------------
# Создаёт shared memory зону для хранения статистики
vhost_traffic_status_zone;

# Размер shared memory (по умолчанию 10m)
# Увеличьте если много vhosts или upstream серверов
# vhost_traffic_status_zone shared:vhost_traffic_status:32m;

# ------------------------------------------------------------------------------
# Фильтрация метрик
# ------------------------------------------------------------------------------
# Группировка по HTTP status code
vhost_traffic_status_filter_by_set_key $status status::*;

# Группировка по upstream
# vhost_traffic_status_filter_by_set_key $upstream_addr upstream::backend::$server_name;

# Группировка по User-Agent
# vhost_traffic_status_filter_by_set_key $http_user_agent agent::*;

# ------------------------------------------------------------------------------
# Исключения
# ------------------------------------------------------------------------------
# Не собирать статистику для health checks
# vhost_traffic_status_bypass_limit on;
# vhost_traffic_status_bypass_stats on;

# ==============================================================================
# Endpoint для просмотра метрик
# ==============================================================================
# Добавьте в ваш server блок или создайте отдельный:
#
# server {
#     listen 127.0.0.1:8080;
#     server_name _;
#
#     location /status {
#         vhost_traffic_status_display;
#         vhost_traffic_status_display_format html;
#         allow 127.0.0.1;
#         allow 172.16.0.0/12;  # Docker networks
#         deny all;
#     }
#
#     location /status/json {
#         vhost_traffic_status_display;
#         vhost_traffic_status_display_format json;
#         allow 127.0.0.1;
#         allow 172.16.0.0/12;
#         deny all;
#     }
#
#     location /status/prometheus {
#         vhost_traffic_status_display;
#         vhost_traffic_status_display_format prometheus;
#         allow 127.0.0.1;
#         allow 172.16.0.0/12;
#         deny all;
#     }
# }
# ==============================================================================

# ==============================================================================
# Доступные метрики
# ==============================================================================
# - Requests per second (total, per vhost)
# - Bandwidth (in/out)
# - Response times (avg, max)
# - Upstream statistics
# - Cache statistics
# - HTTP status codes distribution
# - Active connections
#
# Форматы вывода:
# - HTML - dashboard с графиками
# - JSON - для собственных систем мониторинга
# - Prometheus - для Prometheus/Grafana
# ==============================================================================

# ==============================================================================
# Интеграция с Prometheus
# ==============================================================================
# 1. Включите prometheus формат в location /status/prometheus
# 2. Добавьте в prometheus.yml:
#
# scrape_configs:
#   - job_name: 'angie'
#     static_configs:
#       - targets: ['angie:8080']
#     metrics_path: '/status/prometheus'
# ==============================================================================

# ==============================================================================
# Примечания:
# - Метрики хранятся в RAM (shared memory)
# - Минимальный overhead производительности
# - Обновление в реальном времени
# - Не требует перезапуска для просмотра
# ==============================================================================
