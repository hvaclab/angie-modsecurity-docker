# ==============================================================================
# Docker Compose for Local Testing
# ==============================================================================
# Usage:
#   docker compose -f compose.test.yml up --build
#   docker compose -f compose.test.yml down -v
#
# Ports: 18080 (HTTP), 18443 (HTTPS) - to avoid conflicts with production
#
# Auto-setup: GeoIP and SSL certificates are auto-generated on first start
# ==============================================================================

services:
  angie:
    build:
      context: ./angie
      dockerfile: Dockerfile
    image: angie-with-modsec:test
    container_name: angie-test
    restart: "no"
    ports:
      - "18080:80"
      - "18443:443/tcp"
      - "18443:443/udp"
    environment:
      - TZ=UTC
      - AUTO_UPDATE_GEOIP=false
    volumes:
      # Main config
      - ./angie/angie.conf:/etc/angie/angie.conf:ro
      # Includes
      - ./angie/includes:/etc/angie/includes:ro
      # Virtual hosts
      - ./angie/conf.d:/etc/angie/conf.d:ro
      - ./angie/stream.d:/etc/angie/stream.d:ro
      # GeoIP (rw for auto-download)
      - ./geoip:/etc/angie/geoip
      # SSL certificates (rw for auto-generation)
      - ./certs:/etc/angie/ssl
      # Logs
      - ./logs:/var/log/angie
      # ModSecurity
      - ./modsec:/etc/angie/modsecurity:ro
      # Web
      - ./web:/var/www/html:ro
      - ./errors:/var/www/errors:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "1"

# No external networks or volumes for isolated testing
