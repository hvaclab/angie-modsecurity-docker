# Путь запроса

Этот документ отслеживает, как HTTP-запросы проходят через все слои безопасности и обработки в стеке angie-modsecurity-docker.

## Обзор

Каждый запрос проходит через множественные контрольные точки безопасности перед достижением бэкенда или отдачей статического контента.

```
Запрос клиента
     ↓
[1. TCP/TLS соединение]
     ↓
[2. Rate Limiting]
     ↓
[3. ModSecurity WAF]
     ↓
[4. OAuth2 аутентификация] (опционально)
     ↓
[5. Бэкенд/Статический контент]
     ↓
[6. Ответ и логирование]
     ↓
[7. Offline обработка]
```

## Детальный поток легитимного запроса

```
┌──────────┐
│  Клиент  │
└────┬─────┘
     │
     │ HTTPS запрос: GET /api/data
     │
     ▼
┌─────────────────────────────────────────────────────┐
│ Angie (Port 443)                                    │
│                                                     │
│  [1] TCP/TLS Handshake                              │
│      ├─ SSL/TLS 1.3 (или HTTP/3 QUIC)               │
│      ├─ Валидация сертификата                       │
│      └─ Установка сессии                            │
│                                                     │
│  [2] Проверка Rate Limiting                         │
│      ├─ Извлечь: $binary_remote_addr (IP клиента)   │
│      ├─ Проверить зону: "general" (10 req/s)        │
│      ├─ Решение: 5 req/s → PASS ✓                   │
│      └─ Лог в shared memory                         │
│                                                     │
│  [3] Обогащение логов (Уровень 1)                   │
│      ├─ GeoIP lookup (страна, город, координаты)    │
│      ├─ Парсинг User-Agent (браузер, ОС, устройство)│
│      ├─ Флаги безопасности (подозрительные паттерны)│
│      └─ Подготовка метрик производительности        │
│                                                     │
│  [4] ModSecurity WAF                                │
│      ├─ Обработка фазы запроса                      │
│      │   ├─ Парсинг HTTP заголовков                 │
│      │   ├─ Парсинг тела запроса (если POST/PUT)    │
│      │   ├─ Применение CRS правил (931 правил)      │
│      │   └─ Проверка: Нет SQLi, XSS, LFI → PASS ✓   │
│      └─ Anomaly score: 0 (порог: 5)                 │
│                                                     │
│  [5] OAuth2 аутентификация (если требуется)         │
│      ├─ auth_request /oauth2/auth                   │
│      ├─ Subrequest к oauth2-proxy:4180              │
│      │   ├─ Проверка session cookie                 │
│      │   └─ Возврат: 202 Accepted ✓                 │
│      ├─ Извлечение заголовков пользователя          │
│      │   ├─ X-Auth-Request-User: john@example.com   │
│      │   └─ X-Auth-Request-Email: john@example.com  │
│      └─ Добавление заголовков к запросу бэкенда     │
│                                                     │
│  [6] Проксирование к бэкенду                        │
│      ├─ Разрешение: backend-app:8080 через Docker DNS│
│      ├─ Добавление заголовков                       │
│      └─ Пересылка запроса                           │
└─────────────────────────────────────────────────────┘
     │
     ▼
Backend обрабатывает запрос → Возвращает 200 OK
     │
     ▼
┌─────────────────────────────────────────────────────┐
│ Angie (Фаза ответа)                                 │
│                                                     │
│  [7] ModSecurity проверка ответа                    │
│  [8] Добавление заголовков безопасности             │
│  [9] Сжатие (Brotli)                                │
│  [10] Access лог (буферизованный)                   │
└─────────────────────────────────────────────────────┘
     │
     ▼
Клиент получает ответ
     │
     ▼
[Offline обработка]
  ├─ Vector: обогащение логов (Уровень 2)
  └─ Fail2Ban: мониторинг паттернов
```

## Поток атакующего запроса (блокировка ModSecurity)

```
┌──────────┐
│ Атакующий│
└────┬─────┘
     │
     │ HTTPS запрос: GET /admin' OR 1=1--
     │
     ▼
┌─────────────────────────────────────────────────────┐
│ Angie (Port 443)                                    │
│                                                     │
│  [1] TCP/TLS Handshake → ✓                          │
│  [2] Rate Limiting → PASS ✓ (первый запрос)         │
│  [3] Обогащение логов:                              │
│      ├─ GeoIP: CN (Китай)                           │
│      ├─ User-Agent: sqlmap/1.7.2                    │
│      └─ security_suspicious_ua: "1" ⚠               │
│          security_suspicious_pattern: "1" ⚠         │
│                                                     │
│  [4] ModSecurity WAF                                │
│      ├─ Обработка фазы запроса                      │
│      ├─ Парсинг URI: /admin' OR 1=1--               │
│      ├─ Правило 942100: SQL Injection обнаружен! 🛑 │
│      │   Паттерн: ' OR 1=1--                        │
│      │   Anomaly score: +5                          │
│      ├─ Правило 942190: SQL comment sequence        │
│      │   Паттерн: --                                │
│      │   Anomaly score: +5                          │
│      ├─ Итого anomaly score: 10 (порог: 5) 🛑       │
│      │                                              │
│      └─ ДЕЙСТВИЕ: DENY                              │
│          ├─ Запись в error.log                      │
│          └─ Возврат: 403 Forbidden                  │
└─────────────────────────────────────────────────────┘
     │
     │ HTTPS ответ: 403 Forbidden
     │
     ▼
Атакующий (Запрос заблокирован, бэкенд не достигнут)
     │
     ▼
[Offline обработка]
  ├─ Vector: security_score = 12, threat_level = "high" 🚨
  └─ Fail2Ban: счетчик нарушений, бан после 3 попыток
```

## Поток DDoS атаки (блокировка Rate Limiting)

```
┌──────────┐
│ Атакующий│
└────┬─────┘
     │
     │ 100 запросов/секунду (burst атака)
     │
     ▼
┌─────────────────────────────────────────────────────┐
│ Angie                                               │
│                                                     │
│  [1-10] Первые 10 запросов                          │
│      ├─ Rate limit зона: "general" (10 req/s)       │
│      ├─ В пределах лимита: PASS ✓                   │
│      └─ Обработка нормально                         │
│                                                     │
│  [11-30] Burst запросы (11-30)                      │
│      ├─ Rate: 10 req/s + burst: 20                  │
│      ├─ Использование burst capacity: PASS ✓        │
│      └─ Обработка с nodelay                         │
│                                                     │
│  [31-100] Избыточные запросы                        │
│      ├─ Rate limit ПРЕВЫШЕН 🛑                       │
│      ├─ Burst capacity исчерпан                     │
│      ├─ Возврат: 429 Too Many Requests              │
│      └─ Лог в access.log (status: 429)              │
│                                                     │
│  ModSecurity НЕ ДОСТИГНУТ (rate limit первый)       │
└─────────────────────────────────────────────────────┘
     │
     ▼
Fail2Ban: Обнаружение 100 запросов за минуту → БАН
```

## Характеристики производительности

### Разбивка латентности запроса

Типичный запрос (без блокировок):
```
TCP/TLS Handshake:        ~50ms  (только первый запрос)
Rate Limiting Check:      ~0.01ms (lookup в shared memory)
Log Enrichment:           ~0.1ms  (map lookups, GeoIP)
ModSecurity:              ~2-5ms  (обработка CRS правил)
OAuth2 Check:             ~10ms   (если кэширован, ~100ms если нет)
Backend Processing:       ~50ms   (зависит от приложения)
Response Processing:      ~1ms    (заголовки, сжатие)
Logging (buffered):       ~0.01ms (запись в буфер)
---
Итого: ~113ms (варьируется)
```

Атакующий запрос (заблокирован ModSecurity):
```
TCP/TLS Handshake:        ~50ms
Rate Limiting:            ~0.01ms
Log Enrichment:           ~0.1ms
ModSecurity:              ~3ms (заблокирован рано)
Response (403):           ~0.5ms
---
Итого: ~53.6ms (бэкенд не достигнут)
```

Запрос с превышением rate limit:
```
TCP/TLS Handshake:        ~50ms
Rate Limiting:            ~0.01ms (ЗАБЛОКИРОВАН)
Response (429):           ~0.1ms
---
Итого: ~50.1ms (ModSecurity не достигнут)
```

## Следующие шаги

- Понимание реализации безопасности: [Слои безопасности](security-layers.md)
- Изучение деталей логирования: [Система логирования](logging.md)
- Настройка стека: [Руководство по конфигурации](configuration.md)
- Отладка проблем: [Устранение неполадок](troubleshooting.md)
